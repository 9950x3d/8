
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ë†ì¥ & ë“œë˜ê³¤ & ì•„í‹€ë€í‹°ìŠ¤ (Final Fix)</title>
<style>
  /* ê¸°ë³¸ ì„¤ì • */
  body { margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e8f5e9; user-select:none; padding-bottom: 80px; transition: background 0.5s; }
  input { user-select: text; }

  /* ğŸ”¥ ì§€ì˜¥ ë ë¦„ í…Œë§ˆ */
  body.hell-map { background: #1a0000 !important; color: #ffccbc; }
  body.hell-map header { background: #b71c1c; }
  body.hell-map .area-box { background: #3e2723; color: #ffccbc; box-shadow: 0 0 15px #ff5722; border: 1px solid #ff5722; }
  body.hell-map .area-title { color: #ffab91; border-bottom: 2px solid #8d6e63; }
  body.hell-map .control-panel { background: #210a0a; border-bottom: 1px solid #d84315; }
  body.hell-map .pet-section { background: #260e04; border: 1px solid #ff5722; }
  body.hell-map .pet-card { background: #4e342e; border-color: #ff5722; color: #ffccbc; }
  body.hell-map .btn-buy { background: #d32f2f; }
  body.hell-map .tile { background: #3e2723; border-color: #5d4037; }
  body.hell-map .shop-tab.active { color: #d32f2f; border-bottom-color: #d32f2f; }

  /* ğŸŒŠ ì‹¬í•´(Water) ë ë¦„ í…Œë§ˆ */
  body.water-map { background: #001021 !important; color: #e0f7fa; }
  body.water-map header { background: #01579b; }
  body.water-map .area-box { background: #002f4b; color: #e0f7fa; box-shadow: 0 0 15px #0288d1; border: 1px solid #0288d1; }
  body.water-map .area-title { color: #4fc3f7; border-bottom: 2px solid #0277bd; }
  body.water-map .control-panel { background: #001834; border-bottom: 1px solid #039be5; }
  body.water-map .pet-section { background: #002147; border: 1px solid #0288d1; }
  body.water-map .pet-card { background: #01365e; border-color: #03a9f4; color: #b3e5fc; }
  body.water-map .btn-buy { background: #0277bd; }
  body.water-map .tile { background: #004d40; border-color: #00695c; }
  body.water-map .group-label { color: #81d4fa; }
  body.water-map .shop-tab.active { color: #0288d1; border-bottom-color: #0288d1; }

  /* â˜¢ï¸ ë°©ì‚¬ëŠ¥(Radioactive) ë ë¦„ í…Œë§ˆ */
  body.radio-map { background: #050f00 !important; color: #ccff90; }
  body.radio-map header { background: #33691e; }
  body.radio-map .area-box { background: #1b5e20; color: #ccff90; box-shadow: 0 0 15px #76ff03; border: 1px solid #76ff03; }
  body.radio-map .area-title { color: #76ff03; border-bottom: 2px solid #64dd17; text-shadow: 0 0 5px #76ff03; }
  body.radio-map .control-panel { background: #0f2010; border-bottom: 1px solid #76ff03; }
  body.radio-map .pet-section { background: #000; border: 1px solid #76ff03; }
  body.radio-map .pet-card { background: #1b5e20; border-color: #76ff03; color: #ccff90; }
  body.radio-map .btn-buy { background: #4caf50; color:black; font-weight:bold; }
  body.radio-map .tile { background: #212121; border-color: #76ff03; box-shadow: inset 0 0 10px #76ff03; }
  body.radio-map .shop-tab.active { color: #76ff03; border-bottom-color: #76ff03; background: #1b5e20; }
  body.radio-map .popup { background: #1b5e20; color: #ccff90; border: 2px solid #76ff03; }
  body.radio-map .popup-header { background: #000; color: #76ff03; }
  body.radio-map .btn-popup-close { background: #000; color: #76ff03; border-color: #76ff03; }
  body.radio-map .pet-count { color: #76ff03; }

  /* ìƒë‹¨ ì •ë³´ë°” */
  header {
    background:#2e7d32; color:white; padding:10px 15px; position:sticky; top:0; z-index:900;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; transition: background 0.5s;
  }
  .header-left { display:flex; flex-direction:column; }
  #coins { font-size:22px; font-weight:bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
  #realmDisplay { font-size:12px; color:#fff; margin-top:2px; font-weight:bold; opacity: 0.9; }
  #adminTag { font-size:10px; background:#ffeb3b; color:#000; padding:1px 4px; border-radius:4px; margin-left:5px; display:none; }

  /* ë²„íŠ¼ ê·¸ë£¹ */
  .header-right { display:flex; gap: 10px; }
  .icon-btn { 
    background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); 
    color:white; border-radius:50%; width:35px; height:35px; cursor:pointer; font-size:18px;
    display:flex; justify-content:center; align-items:center; transition:0.2s;
  }
  .icon-btn:hover { background:rgba(255,255,255,0.4); }

  /* ë¹„ë°€ ì½”ë“œ ì…ë ¥ì°½ */
  #codePanel {
    position: fixed; bottom: 10px; left: 10px; z-index: 10000;
    background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3); display:flex; gap:5px;
  }
  #codeInput { border:1px solid #ccc; padding:5px; border-radius:4px; font-size:12px; width: 120px; letter-spacing: 2px; }
  #codeBtn { background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; }

  /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
  .control-panel { background:#fff; padding:10px; border-bottom:1px solid #ddd; display:flex; gap:15px; flex-wrap:wrap; justify-content:center; align-items:flex-start; transition: background 0.5s; }
  .panel-group { display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
  .group-label { font-weight:bold; font-size:14px; color:#555; margin-right:5px; }

  .seed, .item {
    padding:6px 12px; border:2px solid #ccc; cursor:pointer; background:#fafafa; border-radius:15px;
    font-size:13px; font-weight: bold; transition: all 0.2s; box-shadow: 0 2px 2px rgba(0,0,0,0.1);
  }
  .seed:hover, .item:hover { transform: translateY(-2px); box-shadow: 0 4px 5px rgba(0,0,0,0.2); }
  .selected { 
    transform:scale(1.1) !important; box-shadow:0 0 10px rgba(0,0,0,0.3) !important; z-index: 10;
    border-width: 3px !important;
  }

  /* ì‘ë¬¼ ì»¬ëŸ¬ */
  .seed[data-type="potato"] { background: #efebe9; border-color: #8d6e63; color: #5d4037; }
  .seed[data-type="tomato"] { background: #ffebee; border-color: #ef5350; color: #c62828; }
  .seed[data-type="tulip"] { background: #fce4ec; border-color: #f48fb1; color: #ad1457; }
  .seed[data-type="sunflower"] { background: #fffde7; border-color: #fdd835; color: #f57f17; }
  .seed[data-type="wheat"] { background: #fffde7; border-color: #fbc02d; color: #f57f17; }
  .seed[data-type="pumpkin"] { background: #fff3e0; border-color: #ff9800; color: #e65100; }
  .seed[data-type="peach"] { background: #fff0f5; border-color: #ff80ab; color: #c51162; }
  .seed[data-type="moneytree"] { background: #e8f5e9; border-color: #43a047; color: #1b5e20; border-style: double; }
  
  /* ğŸŒŠ ë¬¼ ì‘ë¬¼ */
  .seed[data-type="clam"] { background: #e1f5fe; border-color: #29b6f6; color: #01579b; }
  .seed[data-type="seaweed"] { background: #e0f2f1; border-color: #009688; color: #004d40; }
  .seed[data-type="coral"] { background: #ffebee; border-color: #ef5350; color: #b71c1c; }
  .seed[data-type="starfish"] { background: #fff3e0; border-color: #ff9800; color: #e65100; }
  .seed[data-type="goldenclam"] { background: #fff8e1; border-color: #ffca28; color: #ff6f00; box-shadow: 0 0 5px #ffd700; }

  /* ğŸ”¥ ì§€ì˜¥ ì‘ë¬¼ */
  .seed[data-type="firegrass"] { background: #ffebee; border-color: #ff5722; color: #d84315; }
  .seed[data-type="magmapotato"] { background: #3e2723; border-color: #ffca28; color: #ff6f00; }
  .seed[data-type="hellchili"] { background: #b71c1c; border-color: #d50000; color: #ff8a80; }
  .seed[data-type="cursedflower"] { background: #4a148c; border-color: #880e4f; color: #ea80fc; }
  .seed[data-type="helltree"] { background: #212121; border-color: #b71c1c; color: #ff1744; box-shadow: 0 0 5px #ff5252; }
  .seed[data-type="dragonfruit"] { background: #263238; border-color: #ff1744; color: #ff5252; box-shadow: 0 0 5px #ff1744; }

  /* â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì‘ë¬¼ */
  .seed[data-type="mutanttomato"] { background: #33691e; border-color: #76ff03; color: #ccff90; }
  .seed[data-type="uraniumcorn"] { background: #1b5e20; border-color: #c6ff00; color: #f4ff81; box-shadow: 0 0 5px #c6ff00; }
  .seed[data-type="glowingmushroom"] { background: #004d40; border-color: #00e676; color: #69f0ae; }
  .seed[data-type="nuclearflower"] { background: #212121; border-color: #ff3d00; color: #ff9e80; box-shadow: 0 0 5px #ff3d00; }

  /* ì•„ì´í…œ */
  .item[data-item="water"] { background: #e3f2fd; border-color: #2196f3; color: #0d47a1; }
  .item[data-item="goldwater"] { background: #fff8e1; border-color: #ffca28; color: #ff6f00; }
  .item[data-item="diamondwater"] { background: #e0f7fa; border-color: #00bcd4; color: #006064; }
  .item[data-item="emeraldwater"] { background: #e8f5e9; border-color: #00e676; color: #1b5e20; }
  .item[data-item="adminwater"] { background: #212121; border-color: #000; color: #ffeb3b; border-style: dashed; }
  /* â˜¢ï¸ ë°©ì‚¬ëŠ¥ ë¬¼ */
  .item[data-item="radioactivewater"] { background: #000; border-color: #76ff03; color: #76ff03; box-shadow: 0 0 5px #76ff03; animation: pulse 1s infinite; }

  /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
  #main-container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:20px; }

  /* êµ¬ì—­ ë°•ìŠ¤ */
  .area-box { background:white; padding:15px; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05); transition:background 0.5s; }
  h2.area-title { margin-top:0; text-align:center; color:#333; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px; }

  /* ë†ì¥ ê·¸ë¦¬ë“œ */
  #farm { display:grid; grid-template-columns:repeat(5, 70px); gap:5px; } 
  @media (min-width: 800px) { #farm { grid-template-columns:repeat(10, 70px); } }

  .tile {
    width:70px; height:70px; background:#c2a878; border:2px solid #8b6f47; border-radius:4px;
    display:flex; justify-content:center; align-items:center; position:relative; cursor:pointer;
    transition: all 0.5s;
  }

  .plant { font-size:35px; z-index:2; }
  .timer { 
    position:absolute; bottom:2px; font-size:10px; color:white;
    background:rgba(0,0,0,0.6); padding:1px 4px; border-radius:4px; pointer-events:none; z-index:3;
  }
  
  /* í”Œë¡œíŒ… í…ìŠ¤íŠ¸ */
  .float-text {
    position:absolute; color:#ffeb3b; font-weight:bold; font-size:16px; z-index:10;
    text-shadow: 1px 1px 2px black; animation: floatUp 0.8s forwards; pointer-events: none; width: 100%; text-align: center;
  }
  @keyframes floatUp { 0% { transform:translateY(0); opacity:1; } 100% { transform:translateY(-40px); opacity:0; } }

  /* ë™ë¬¼ ë†ì¥ */
  #animalFarm { width: 320px; }
  .pet-section { margin-bottom: 20px; background:#f9f9f9; padding:10px; border-radius:10px; }
  .pet-stats { display:flex; justify-content:space-around; margin-bottom:10px; }
  .pet-card { text-align:center; font-size:12px; background:#fff; padding:8px 5px; border-radius:8px; border:1px solid #eee; width:30%; box-shadow:0 2px 2px rgba(0,0,0,0.05); }
  .pet-icon { font-size:24px; display:block; margin-bottom:2px; }
  .pet-count { font-weight:bold; color:#009688; font-size:16px; }
  body.hell-map .pet-count { color: #ff5722; }
  
  .egg-btn {
    width:100%; padding:12px; color:white; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer; margin-top:5px;
    transition: transform 0.1s;
  }
  .egg-btn:active { transform:translateY(2px); }
  
  .btn-normal { background:#ff9800; }
  .btn-sea { background:#2196f3; }
  .btn-hell { background:#d84315; }
  .btn-legend { background:#d50000; box-shadow: 0 4px 0 #b71c1c; animation: glow 2s infinite; }
  .btn-admin { background:#263238; border:1px solid #fff; box-shadow: 0 4px 0 #000; }
  /* â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì•Œ ë²„íŠ¼ */
  .btn-radio { background: #1b5e20; border: 2px solid #76ff03; color: #76ff03; font-weight: bold; box-shadow: 0 4px 0 #006400; }
  
  @keyframes glow { 0% { box-shadow: 0 0 5px #d50000; } 50% { box-shadow: 0 0 15px #ff1744; } 100% { box-shadow: 0 0 5px #d50000; } }

  /* íŒì—… ê³µí†µ */
  .popup {
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#fff; padding:0; border-radius:15px; z-index:99999;
    width:400px; max-width: 90%; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    overflow: hidden;
  }
  /* íŒì—… í—¤ë” ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½ (#4caf50) */
  .popup-header { background:#4caf50; color:white; padding:15px; font-size:20px; font-weight:bold; }
  .popup-content { padding: 20px; }
  .hidden { display:none !important; }

  /* í€˜ìŠ¤íŠ¸ íŒì—… */
  .quest-item { background: #f5f5f5; padding: 10px; margin-bottom: 5px; border-radius: 8px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
  .quest-desc { font-weight: bold; font-size: 14px; }
  .quest-progress { font-size: 12px; color: #666; }
  
  /* ìƒì  íƒ­ */
  .shop-tabs { display:flex; justify-content:space-around; background:#f0f0f0; border-bottom:1px solid #ddd; }
  .shop-tab { padding:10px 15px; cursor:pointer; font-weight:bold; color:#555; border-bottom:3px solid transparent; width:50%; text-align:center; }
  /* ê¸°ë³¸ í™œì„± íƒ­ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  .shop-tab.active { color:#2e7d32; border-bottom:3px solid #2e7d32; background:white; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }
  
  /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
  .list-container { max-height: 250px; overflow-y: auto; text-align:left; margin-bottom:15px; border:1px solid #eee; border-radius:8px; padding: 5px 0; }
  .shop-item, .inv-item { padding:10px 15px; border-bottom:1px solid #f7f7f7; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-flat { background:#eee; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold; }
  /* ê¸°ë³¸ êµ¬ë§¤ ë²„íŠ¼ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  .btn-buy { background:#4caf50; color:white; }
  
  .btn-diff-select, .btn-popup-close { 
    display:block; width:100%; margin:10px 0; padding:12px; font-size:16px; 
    background:#fff; border:2px solid #ddd; border-radius:8px; cursor:pointer; transition:0.2s;
  }
  .btn-diff-select:hover, .btn-popup-close:hover { background:#f5f5f5; }

  .btn-harvest-all {
    width: 100%; margin-top: 10px; padding: 12px; font-weight: bold; background: #8bc34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px #558b2f;
  }
  .btn-harvest-all:active { box-shadow: 0 2px #558b2f; transform: translateY(2px); }

  /* ì•Œ ê°œë´‰ ë²„íŠ¼ ê·¸ë£¹ */
  .hatch-btn-group { display:flex; gap:3px; margin-top:5px; }
  .hatch-btn-group button { padding: 4px 8px; font-size:11px; cursor:pointer; border:none; border-radius:4px; color:white; transition:0.1s; }
  .hatch-btn-group button:active { transform:scale(0.95); }
  
  .btn-egg-land { background: #ff9800; }
  .btn-egg-sea { background: #2196f3; }
  .btn-egg-hell { background: #d84315; }
  .btn-egg-legend { background: #d50000; }
  .btn-egg-admin { background: #212121; border:1px solid #fff; }
  .btn-egg-radio { background: #1b5e20; border:1px solid #76ff03; color:#76ff03; }

  /* ë©”ë‰´ ë²„íŠ¼ */
  #inventoryBtn, #shopBtn {
    position:fixed; right:20px; width:50px; height:50px; border-radius:50%;
    background:white; cursor:pointer; border:2px solid #ccc; font-size:20px;
    z-index:1000000; box-shadow:0 4px 6px rgba(0,0,0,0.2); display:flex; justify-content:center; align-items:center;
  }
  /* ìƒì  ë²„íŠ¼ ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½ (ì´ˆë¡ ê³„ì—´) */
  #shopBtn { bottom:80px; background:#e8f5e9; color:#2e7d32; border-color:#4caf50; }
  #inventoryBtn { bottom:20px; background:#fff3e0; color:#e64a19; border-color:#ff9800; }
  
  /* í« ë¶€í™” ì°½ */
  #hatchWindow { 
    z-index: 20000000 !important;
    background: linear-gradient(135deg, #e3f2fd, #fff); 
    border: 5px solid #0288d1; 
    pointer-events: auto; 
  }
  .egg-hatch-animation { animation: pulse 0.5s infinite alternate, shine 1s; padding:20px; border-radius:15px; }
  @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
  .hatch-result-text { font-size:24px; font-weight:bold; color:#01579b; margin-top:10px; word-break: keep-all; }

</style>
</head>
<body>

<header>
  <div class="header-left">
    <div id="coins">ğŸ’° 0</div>
    <div id="realmDisplay">í˜„ì¬: ğŸ¡ ì¼ë°˜ ë†ì¥ <span id="adminTag">ADMIN</span></div>
  </div>
  <div class="header-right">
    <button class="icon-btn" id="questBtn" title="í€˜ìŠ¤íŠ¸">ğŸ“œ</button>
    <button class="icon-btn" id="settingBtn" title="ì„¤ì •/ì´ˆê¸°í™”">âš™ï¸</button>
    <button class="icon-btn" id="saveIndicator" title="ìë™ì €ì¥ë¨" style="display:none; color:#76ff03;">ğŸ’¾</button>
  </div>
  <div id="msg" style="position:absolute; top:50px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:5px 10px; border-radius:20px; font-size:12px; pointer-events:none; transition:opacity 0.5s;">í™˜ì˜í•©ë‹ˆë‹¤!</div>
</header>

<!-- ë¹„ë°€ ì½”ë“œ ì…ë ¥ -->
<div id="codePanel">
  <input type="password" id="codeInput" placeholder="ë¹„ë°€ ì½”ë“œ">
  <button id="codeBtn">ì´ë™</button>
</div>

<button id="shopBtn" title="ìƒì ">ğŸ›’</button>
<button id="inventoryBtn" title="ì¸ë²¤í† ë¦¬">ğŸ’</button>

<!-- ë‚œì´ë„/ì„¤ì • ìœˆë„ìš° -->
<div id="settingWindow" class="popup hidden">
  <div class="popup-header">âš™ï¸ ì„¤ì •</div>
  <div class="popup-content">
    <div style="margin-bottom:15px; color:#555; font-size:14px;">ê²Œì„ì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    <button class="btn-diff-select" data-diff="easy">ğŸ™‚ ë‚œì´ë„: ì‰¬ì›€</button>
    <button class="btn-diff-select" data-diff="normal">ğŸ˜ ë‚œì´ë„: ë³´í†µ</button>
    <button class="btn-diff-select" data-diff="hard">ğŸ˜« ë‚œì´ë„: ì–´ë ¤ì›€</button>
    <hr>
    <button class="btn-popup-close" id="resetGameBtn" style="background:#ffcdd2; color:#c62828; border-color:#e57373;">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
    <button class="btn-popup-close" id="closeSetting">ë‹«ê¸°</button>
  </div>
</div>

<!-- í€˜ìŠ¤íŠ¸ ìœˆë„ìš° -->
<div id="questWindow" class="popup hidden">
  <div class="popup-header">ğŸ“œ ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ (ë¬´í•œ)</div>
  <div class="popup-content">
    <div id="questList" class="list-container">
      <!-- ë™ì  ìƒì„± -->
    </div>
    <button class="btn-popup-close" id="closeQuest">ë‹«ê¸°</button>
  </div>
</div>

<!-- í« ê°œë´‰ ì°½ -->
<div id="hatchWindow" class="popup hidden">
  <h2>í« ë¶€í™”!</h2>
  <div class="egg-hatch-animation">
    <div id="hatchIcon" style="font-size:80px;">ğŸ¥š</div>
  </div>
  <div class="hatch-result-text" id="hatchName">...</div>
  <div style="font-size:12px; margin-top:5px; color:#555; max-height:100px; overflow-y:auto;" id="hatchSummary"></div>
  <button class="btn-popup-close" id="closeHatchBtn" style="margin-top:15px; background:#0288d1; color:white; font-weight:bold; cursor:pointer;">í™•ì¸</button>
</div>

<!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
<div class="control-panel">
  <div class="panel-group">
    <span class="group-label">ğŸŒ± ì”¨ì•—:</span>
    <div id="seeds" style="display:flex; gap:5px;"></div>
  </div>
  <div class="panel-group">
    <span class="group-label">ğŸ›  ë„êµ¬:</span>
    <div id="items" style="display:flex; gap:5px;">
      <div class="item" data-item="water">ğŸ’§ ë¬¼</div>
      <div class="item" data-item="goldwater">âœ¨ í™©ê¸ˆ</div>
      <div class="item" data-item="diamondwater">ğŸ’ ë‹¤ì´ì•„</div>
      <div class="item" data-item="emeraldwater">ğŸ’š ì—ë©”ë„ë“œ</div>
      <div class="item" data-item="adminwater">âš¡ ê´€ë¦¬ì</div>
      <div class="item" data-item="radioactivewater" style="display:none;">â˜¢ï¸ ë°©ì‚¬ëŠ¥</div>
    </div>
  </div>
</div>

<!-- ë©”ì¸ ì˜ì—­ -->
<div id="main-container">
  
  <div class="area-box">
    <h2 class="area-title">ğŸŒ½ ë†ì¥</h2>
    <div id="farm"></div>
    <button class="btn-harvest-all" id="harvestAllBtn">ğŸšœ ì „ì²´ ìˆ˜í™•</button>
  </div>

  <div class="area-box" id="animalFarm">
    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í« êµ¬ì—­ ë™ì  ìƒì„± -->
  </div>

</div>

<!-- ìƒì  íŒì—… -->
<div id="shopWindow" class="popup hidden">
  <div class="popup-header">ğŸª ìƒì </div>
  <div class="shop-tabs">
    <div class="shop-tab active" data-tab="seeds-tab">ğŸŒ± ì”¨ì•—/ì•Œ</div>
    <div class="shop-tab" data-tab="items-tab">ğŸ›  ì•„ì´í…œ</div>
  </div>
  <div class="popup-content">
    <div class="tab-content active" id="seeds-tab">
      <div class="list-container" id="shopSeedList"></div>
    </div>
    <div class="tab-content" id="items-tab">
      <div class="list-container" id="shopItemList"></div>
    </div>
    <button id="closeShop" class="btn-popup-close">ë‹«ê¸°</button>
  </div>
</div>

<!-- ì¸ë²¤í† ë¦¬ íŒì—… -->
<div id="inventoryWindow" class="popup hidden">
  <div class="popup-header">ğŸ’ ì¸ë²¤í† ë¦¬</div>
  <div class="popup-content">
    <div class="list-container" id="inventoryListContainer">
      <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¸ë²¤í† ë¦¬ ë™ì  ìƒì„± -->
    </div>
    <button id="closeInv" class="btn-popup-close">ë‹«ê¸°</button>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {

  // ========================
  // 1. ë°ì´í„° ì„¤ì •
  // ========================
  let coins = 0;
  let growSpeed = 1; 
  let currentRealm = "normal"; 
  let currentDiff = "normal"; 
  let isAdminMode = false; // ê´€ë¦¬ì ëª¨ë“œ ì—¬ë¶€
  
  // ì½”ë“œ ì‚¬ìš© ì—¬ë¶€ ì €ì¥
  let isCodeUsed_130622 = false;
  let isCodeUsed_dlalsgh1215 = false;
  let isCodeUsed_538889 = false;
  let isCodeUsed_2437 = false;
  
  let currentQuest = null; 

  const petInfo = {
    // [Normal]
    dog: { name: "ê°•ì•„ì§€", icon: "ğŸ¶", desc: "ì„±ì¥ ì†ë„ 5% â†‘" },
    cat: { name: "ê³ ì–‘ì´", icon: "ğŸ±", desc: "10ì´ˆë§ˆë‹¤ 1,000ì½”ì¸" },
    frog: { name: "ê°œêµ¬ë¦¬", icon: "ğŸ¸", desc: "1ë¶„ë§ˆë‹¤ ê¸‰ì„±ì¥" },
    
    // [Water - ë³µêµ¬ë¨]
    seal: { name: "ë¬¼ê°œ", icon: "ğŸ¦­", desc: "íŒë§¤ ê°€ê²© 5% â†‘" },
    crab: { name: "ê½ƒê²Œ", icon: "ğŸ¦€", desc: "10% í™•ë¥ ë¡œ ì•„ì´í…œ" },
    shark: { name: "ìƒì–´", icon: "ğŸ¦ˆ", desc: "20% í™•ë¥ ë¡œ 2ë°° ì½”ì¸" },
    
    // [Hell]
    imp: { name: "ì„í”„", icon: "ğŸ˜ˆ", desc: "íŒë§¤ ê°€ê²© 10% â†‘" },
    cerberus: { name: "ì¼€ë¥´ë² ë¡œìŠ¤", icon: "ğŸ•â€ğŸ¦º", desc: "ì„±ì¥ ì†ë„ 1.5ë°° (ë¶ˆ)" },
    devil: { name: "ì•…ë§ˆ", icon: "ğŸ‘º", desc: "30% í™•ë¥ ë¡œ 2ë°° ì½”ì¸" },
    
    phoenix: { name: "ë¶ˆì‚¬ì¡°", icon: "ğŸ¦…", desc: "ì„±ì¥ ì†ë„ 2ë°° (ê°•ë ¥)" },
    hydra: { name: "íˆë“œë¼", icon: "ğŸ", desc: "íŒë§¤ ê°€ê²© 3ë°° (ê°•ë ¥)" },
    dragon: { name: "ë“œë˜ê³¤", icon: "ğŸ²", desc: "ì„±ì¥2ë°°+íŒë§¤5ë°°+ê´‘ì—­ì„±ì¥" },

    // [Radioactive - New]
    slime: { name: "ìŠ¬ë¼ì„", icon: "ğŸ¦ ", desc: "10ì´ˆë§ˆë‹¤ ë°©ì‚¬ëŠ¥ ì½”ì¸ íšë“" },
    mutantfish: { name: "ëŒì—°ë³€ì´ ë¬¼ê³ ê¸°", icon: "ğŸŸ", desc: "ì„±ì¥ ì†ë„ 20% â†‘" },
    spider: { name: "ê±°ëŒ€ ê±°ë¯¸", icon: "ğŸ•·ï¸", desc: "íŒë§¤ ê°€ê²© 50% â†‘" }
  };
  
  let pets = { dog:0, cat:0, frog:0, seal:0, crab:0, shark:0, imp:0, cerberus:0, devil:0, phoenix:0, hydra:0, dragon:0, slime:0, mutantfish:0, spider:0 };

  const allPlants = {
    // [ì¼ë°˜]
    potato:   {name:"ğŸ¥”ê°ì", cost:10,  sell:15,  grow:2*60000,  stages:["ğŸŒ±","ğŸŒ¿","ğŸ¥”"], realm:"normal"},
    tomato:   {name:"ğŸ…í† ë§ˆí† ", cost:30,  sell:45,  grow:5*60000,  stages:["ğŸŒ±","ğŸŒ¿","ğŸ…"], realm:"normal"},
    tulip:    {name:"ğŸŒ·íŠ¤ë¦½", cost:50,  sell:80,  grow:10*60000, stages:["ğŸŒ±","ğŸŒ¿","ğŸŒ·"], realm:"normal"},
    sunflower:{name:"ğŸŒ»í•´ë°”ë¼ê¸°", cost:80, sell:120, grow:12*60000, stages:["ğŸŒ±","ğŸŒ»","ğŸŒ»"], realm:"normal"}, 
    wheat:    {name:"ğŸŒ¾ë°€",   cost:100, sell:150, grow:15*60000, stages:["ğŸŒ±","ğŸŒ¿","ğŸŒ¾"], realm:"normal"},
    pumpkin:  {name:"ğŸƒí˜¸ë°•", cost:150, sell:230, grow:20*60000, stages:["ğŸŒ±","ğŸŒ¿","ğŸƒ"], realm:"normal"},
    peach:    {name:"ğŸ‘ë³µìˆ­ì•„", cost:500, sell:666, grow:50*60000, stages:["ğŸŒ±","ğŸŒ¿","ğŸ‘"], realm:"normal"},
    moneytree:{name:"ğŸ’°ëˆë‚˜ë¬´", cost:100000, sell:0, grow:60*60000, stages:["ğŸŒ±","ğŸŒ³","ğŸ’°"], realm:"normal", isSpecial:true},
    
    // [ì‹¬í•´ - Water]
    seaweed:  {name:"ğŸŒ¿ë¯¸ì—­", cost:50, sell:90, grow:5*60000, stages:["ğŸ’§","ğŸŒ¿","ğŸŒ¿"], realm:"water"},
    clam:     {name:"ğŸšì¡°ê°œ", cost:444, sell:555, grow:44*60000, stages:["ğŸ’§","ğŸš","âœ¨ğŸš"], realm:"water"}, 
    coral:    {name:"ğŸª¸ì‚°í˜¸", cost:200, sell:350, grow:20*60000, stages:["ğŸ’§","ğŸª¸","ğŸª¸"], realm:"water"},
    starfish: {name:"â­ë¶ˆê°€ì‚¬ë¦¬", cost:500, sell:900, grow:45*60000, stages:["ğŸ’§","â­","â­"], realm:"water"},
    goldenclam:{name:"ğŸší™©ê¸ˆì¡°ê°œ", cost:2000, sell:5000, grow:120*60000, stages:["ğŸ’§","ğŸš","ğŸ‘‘"], realm:"water"},

    // [ì§€ì˜¥ - Hell]
    firegrass:    {name:"ğŸ”¥ë¶ˆê½ƒí’€", cost:700, sell:1500, grow:30*60000, stages:["ğŸ”¥","ğŸŒ¿","ğŸ”¥"], realm:"hell"},
    magmapotato:  {name:"ğŸ¥”ë§ˆê·¸ë§ˆê°ì", cost:1000, sell:2200, grow:50*60000, stages:["ğŸŒ±","ğŸ”¥","ğŸ¥”"], realm:"hell"},
    hellchili:    {name:"ğŸŒ¶ì§€ì˜¥ê³ ì¶”", cost:1500, sell:3500, grow:80*60000, stages:["ğŸŒ±","ğŸŒ¶","ğŸ”¥"], realm:"hell"},
    cursedflower: {name:"ğŸ¥€ì €ì£¼ê½ƒ", cost:2500, sell:6000, grow:100*60000, stages:["ğŸŒ±","ğŸ¥€","ğŸ‘»"], realm:"hell"},
    helltree:     {name:"ğŸ‘¹ì§€ì˜¥ë‚˜ë¬´", cost:3500, sell:8000, grow:120*60000, stages:["ğŸ”¥","ğŸŒ²","ğŸ‘¹"], realm:"hell"},
    
    // [ê´€ë¦¬ì]
    dragonfruit:{name:"ğŸ²ìš©ê³¼", cost:0, sell:500000, grow:30*1000, stages:["ğŸ”¥","ğŸ‰","ğŸ²"], realm:"hell", isSpecial:true},

    // [ë°©ì‚¬ëŠ¥ - Radioactive]
    mutanttomato: {name:"ğŸ…ëŒì—°ë³€ì´ í† ë§ˆí† ", cost:2000, sell:3500, grow:40*60000, stages:["ğŸŒ±","ğŸŒ¿","ğŸ…"], realm:"radioactive"},
    uraniumcorn: {name:"ğŸŒ½ìš°ë¼ëŠ„ ì˜¥ìˆ˜ìˆ˜", cost:4000, sell:8000, grow:60*60000, stages:["ğŸŒ±","ğŸŒ½","ğŸ”¥"], realm:"radioactive"},
    glowingmushroom: {name:"ğŸ„í˜•ê´‘ ë²„ì„¯", cost:6000, sell:12000, grow:90*60000, stages:["ğŸŒ±","ğŸ„","âœ¨"], realm:"radioactive"},
    nuclearflower: {name:"ğŸ¥€í•µíê¸°ë¬¼ ê½ƒ", cost:10000, sell:25000, grow:120*60000, stages:["ğŸŒ±","ğŸ¥€","â˜¢ï¸"], realm:"radioactive"}
  };

  const itemInfo = {
    water:       {name:"ë¬¼ë¿Œë¦¬ê°œ", cost:100, reduce:5*60000},
    goldwater:   {name:"í™©ê¸ˆë¬¼ë¿Œë¦¬ê°œ", cost:250, reduce:25*60000},
    diamondwater:{name:"ë‹¤ì´ì•„ë¬¼ë¿Œë¦¬ê°œ", cost:500, reduce:45*60000},
    emeraldwater:{name:"ì—ë©”ë„ë“œë¬¼", cost:1000, reduce:120*60000},
    adminwater:  {name:"âš¡ê´€ë¦¬ìë¬¼", cost:0, reduce:999999999},
    radioactivewater: {name:"â˜¢ï¸ë°©ì‚¬ëŠ¥ë¬¼", cost:3000, reduce:300*60000} // 5ì‹œê°„
  };

  let inventory = { 
    egg:0, seaEgg:0, hellEgg:0, legendEgg:0, adminEgg:0, radioEgg:0,
    water:0, goldwater:0, diamondwater:0, emeraldwater:0, adminwater:0, radioactivewater:0,
    pearl:0
  };
  for(let key in allPlants) inventory[key] = 0; 

  let selectedSeed = null;
  let selectedItem = null;

  // ========================
  // 2. ì´ˆê¸°í™” ë° ë¡œë“œ
  // ========================
  
  const farm = document.getElementById("farm");
  for(let i=0; i<50; i++){
    const t = document.createElement("div");
    t.className = "tile";
    t.id = `tile-${i}`; 
    t.onclick = () => onTileClick(t);
    farm.appendChild(t);
  }

  loadGame(); 
  if(!currentQuest) generateNewQuest(); 

  refreshUI();

  // ìƒì  íƒ­ ê¸°ëŠ¥
  document.querySelectorAll('.shop-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // ========================
  // 3. ì°¨ì› ì´ë™ / ì½”ë“œ
  // ========================
  document.getElementById("codeBtn").onclick = checkCode;
  function checkCode() {
    const val = document.getElementById("codeInput").value;
    
    if(val === "yyyuy987") { // Hell
        if(currentRealm === "hell") return;
        changeRealm("hell");
        showMsg("ğŸ”¥ ì§€ì˜¥ ì°¨ì› ì´ë™!");
    } else if(val === "a12341234") { // Normal
        if(currentRealm === "normal") return;
        changeRealm("normal");
        showMsg("ğŸ¡ ì¼ë°˜ ë†ì¥ ë³µê·€!");
    } else if(val === "yyyuy789") { // Water
        if(currentRealm === "water") return;
        changeRealm("water");
        showMsg("ğŸŒŠ ì‹¬í•´ ì°¨ì› ì´ë™!");
    } else if(val === "130622") { // Bonus Code
        if(isCodeUsed_130622) {
            alert("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.");
        } else {
            coins += 1000;
            isCodeUsed_130622 = true;
            updateCoinDisplay();
            saveGame();
            showMsg("ğŸ ì½”ë“œ ì…ë ¥ ì™„ë£Œ! 1000ì½”ì¸ íšë“!");
        }
    } else if(val === "dlalsgh1215") { // New Code 1
        if(isCodeUsed_dlalsgh1215) {
            alert("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.");
        } else {
            coins += 30000;
            isCodeUsed_dlalsgh1215 = true;
            updateCoinDisplay();
            saveGame();
            showMsg("ğŸ 30000ì½”ì¸ íšë“!");
        }
    } else if(val === "538889") { // New Code 2
        if(isCodeUsed_538889) {
            alert("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.");
        } else {
            inventory.adminwater++;
            isCodeUsed_538889 = true;
            updateInventoryUI();
            saveGame();
            showMsg("âš¡ ê´€ë¦¬ì ë¬¼ 1ê°œ íšë“!");
        }
    } else if(val === "2437") { // Radioactive Event
        if(!isCodeUsed_2437) {
            inventory.radioactivewater += 3;
            isCodeUsed_2437 = true;
            changeRealm("radioactive");
            saveGame();
            showMsg("â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì˜¤ì—¼ ê²½ë³´! (ë¬¼ 3ê°œ íšë“)");
        } else {
            changeRealm("radioactive");
            showMsg("â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì§€ì—­ìœ¼ë¡œ ì´ë™");
        }
    } else if(val === "444") { // Admin Mode ON
        isAdminMode = true;
        coins = 999999999; // ë¬´í•œ ì½”ì¸ ì ìš©
        growSpeed = 50; // ì„±ì¥ ì†ë„ ì¦ê°€
        saveGame();
        refreshUI();
        document.getElementById("adminTag").style.display = "inline-block";
        showMsg("ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”! (ë¬´í•œ ì½”ì¸)");
    } else if(val === "4444") { // Admin Mode OFF
        isAdminMode = false;
        coins = 0; // ì½”ì¸ ì´ˆê¸°í™”
        // ëª¨ë“œ í•´ì œ ì‹œ í˜„ì¬ ë ë¦„ì— ë§ëŠ” ì†ë„ë¡œ ì¬ì„¤ì •
        if(currentRealm === "radioactive") growSpeed = 3;
        else growSpeed = 1;

        updateCoinDisplay(); 
        saveGame();
        refreshUI();
        document.getElementById("adminTag").style.display = "none";
        showMsg("ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ í•´ì œ (ì½”ì¸ ì´ˆê¸°í™”)");
    } else {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œ");
    }
    document.getElementById("codeInput").value = "";
  }

  function changeRealm(realm) {
    currentRealm = realm;
    document.body.classList.remove("hell-map", "water-map", "radio-map");
    
    // ì„±ì¥ ì†ë„ ë³´ë„ˆìŠ¤ ì´ˆê¸°í™” (ê´€ë¦¬ìëª¨ë“œ ì•„ë‹ˆë©´ 1 ë˜ëŠ” ë ë¦„ íŠ¹í™”)
    if(!isAdminMode) {
        if(realm === "radioactive") growSpeed = 3;
        else growSpeed = 1;
    }

    let realmText = "ğŸ¡ ì¼ë°˜ ë†ì¥";

    if(realm === "hell") {
        document.body.classList.add("hell-map");
        realmText = "ğŸ”¥ ì§€ì˜¥ ì°¨ì›";
    } else if(realm === "water") {
        document.body.classList.add("water-map");
        realmText = "ğŸŒŠ ì‹¬í•´ ì°¨ì›";
    } else if(realm === "radioactive") {
        document.body.classList.add("radio-map");
        realmText = "â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì´ë²¤íŠ¸ ì§€ì—­";
    }

    document.getElementById("realmDisplay").innerHTML = `í˜„ì¬: ${realmText} <span id='adminTag' style='display:${isAdminMode?'inline-block':'none'}'>ADMIN</span>`;
    
    generateNewQuest(); 
    selectedSeed = null; selectedItem = null;
    refreshUI();
  }

  // --- ì €ì¥ ê¸°ëŠ¥ ---
  function saveGame() {
    const tileData = [];
    document.querySelectorAll(".tile").forEach(t => {
        tileData.push({
            plant: t.dataset.plant || "",
            time: t.dataset.time || 0,
            touches: t.dataset.touches || 0
        });
    });

    const saveData = {
        coins, pets, inventory, currentRealm, currentDiff, currentQuest, tileData,
        isCodeUsed_130622, isCodeUsed_dlalsgh1215, isCodeUsed_538889, isCodeUsed_2437,
        isAdminMode, growSpeed
    };
    localStorage.setItem("farmGameSave_Ult_Final", JSON.stringify(saveData));
    
    const ind = document.getElementById("saveIndicator");
    ind.style.display = "flex";
    setTimeout(() => ind.style.display="none", 1000);
  }

  function loadGame() {
    const data = localStorage.getItem("farmGameSave_Ult_Final");
    if(data) {
        try {
            const parsed = JSON.parse(data);
            
            // ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ (Infinity/NaN ë°©ì§€)
            coins = Number(parsed.coins) || 0;
            if(parsed.pets) {
                for(let k in pets) {
                    pets[k] = Number(parsed.pets[k]) || 0;
                }
            }
            
            // ì¸ë²¤í† ë¦¬ ë³‘í•© ë¡œì§ (ì‹ ê·œ ì•„ì´í…œ ëˆ„ë½ ë°©ì§€)
            if(parsed.inventory) {
                inventory = parsed.inventory;
                // ëˆ„ë½ëœ í‚¤ ì±„ì›Œë„£ê¸° & NaN ë°©ì§€
                for(let key in allPlants) {
                    if(typeof inventory[key] === 'undefined' || isNaN(inventory[key])) inventory[key] = 0;
                }
                if(typeof inventory.radioactivewater === 'undefined' || isNaN(inventory.radioactivewater)) inventory.radioactivewater = 0;
                if(typeof inventory.radioEgg === 'undefined' || isNaN(inventory.radioEgg)) inventory.radioEgg = 0;
            }

            currentRealm = parsed.currentRealm || "normal";
            currentDiff = parsed.currentDiff || "normal";
            currentQuest = parsed.currentQuest || null;
            
            // ì½”ë“œ ì‚¬ìš© ìƒíƒœ ë° ê´€ë¦¬ì ëª¨ë“œ ë¡œë“œ
            isCodeUsed_130622 = parsed.isCodeUsed_130622 || false;
            isCodeUsed_dlalsgh1215 = parsed.isCodeUsed_dlalsgh1215 || false;
            isCodeUsed_538889 = parsed.isCodeUsed_538889 || false;
            isCodeUsed_2437 = parsed.isCodeUsed_2437 || false;
            
            isAdminMode = parsed.isAdminMode || false;
            
            // ì„±ì¥ ì†ë„ ì•ˆì „ ì¥ì¹˜ (0ì´ê±°ë‚˜ NaNì´ë©´ 1ë¡œ ë³µêµ¬)
            growSpeed = Number(parsed.growSpeed) || 1;
            if(growSpeed <= 0) growSpeed = 1;
            
            changeRealm(currentRealm);
            
            if(parsed.tileData) {
                const tiles = document.querySelectorAll(".tile");
                parsed.tileData.forEach((d, i) => {
                    if(tiles[i] && d.plant && allPlants[d.plant]) { // ì‹ë¬¼ ë°ì´í„°ê°€ ìœ íš¨í•œì§€ í™•ì¸
                        tiles[i].dataset.plant = d.plant;
                        // ì‹œê°„ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ê°•ì œë¡œ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
                        tiles[i].dataset.time = (d.time && !isNaN(d.time) && d.time !== "Infinity") ? d.time : Date.now();
                        
                        if(d.touches) tiles[i].dataset.touches = d.touches;
                        
                        const initialIcon = (d.plant==='dragonfruit'?'ğŸ”¥':(d.plant==='helltree'?'ğŸ”¥':(d.plant==='clam'||d.plant==='seaweed'?'ğŸ’§':'ğŸŒ±')));
                        tiles[i].innerHTML = `<div class="plant">${initialIcon}</div><div class="timer">...</div>`;
                    }
                });
            }
        } catch(e) {
            console.error("ì„¸ì´ë¸Œ íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
            alert("ì„¸ì´ë¸Œ íŒŒì¼ì´ ì†ìƒë˜ì–´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            resetGame();
        }
    }
  }

  function resetGame() {
      if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          localStorage.removeItem("farmGameSave_Ult_Final");
          location.reload();
      }
  }

  setInterval(saveGame, 10000);

  // ========================
  // 4. UI ë Œë”ë§
  // ========================
  function refreshUI() {
    renderSeeds(); renderShop(); renderAnimalFarm(); updateInventoryUI(); updateCoinDisplay();
    
    const radioItem = document.querySelector('.item[data-item="radioactivewater"]');
    if(inventory.radioactivewater > 0 || currentRealm === 'radioactive') {
        radioItem.style.display = "block";
    } else {
        radioItem.style.display = "none";
    }

    document.getElementById("adminTag").style.display = isAdminMode ? "inline-block" : "none";
  }

  function renderSeeds() {
    const seedContainer = document.getElementById("seeds");
    seedContainer.innerHTML = "";
    
    for(let key in allPlants){
        if(allPlants[key].realm === currentRealm){
            if(key === 'dragonfruit' && !isAdminMode) continue;
            const div = document.createElement("div");
            div.className = "seed";
            div.dataset.type = key;
            div.textContent = allPlants[key].name;
            div.onclick = () => {
                if(selectedSeed === key) selectedSeed = null;
                else { selectedSeed = key; selectedItem = null; }
                updateSelectionUI();
            };
            seedContainer.appendChild(div);
        }
    }
    updateSelectionUI();
  }

  function renderShop() {
    const shopSeedList = document.getElementById("shopSeedList");
    shopSeedList.innerHTML = "";
    
    for(let key in allPlants){
        const p = allPlants[key];
        if(p.realm === currentRealm){
            if(key === 'dragonfruit' && !isAdminMode) continue;
            shopSeedList.innerHTML += `<div class="shop-item"><span>${p.name} (${p.cost}ì½”ì¸)</span><button class="btn-flat btn-buy buySeedBtn" data-seed="${key}">êµ¬ë§¤</button></div>`;
        }
    }
    
    if(currentRealm === "normal") {
        shopSeedList.innerHTML += `<div class="shop-item" style="background:#fff3e0;"><span>ğŸ¥š **ìœ¡ì§€ ì•Œ** (100)</span><button class="btn-flat btn-buy buyEggBtn" data-type="egg">êµ¬ë§¤</button></div>`;
    } else if(currentRealm === "water") {
        shopSeedList.innerHTML += `<div class="shop-item" style="background:#e1f5fe;"><span>ğŸ”µ **ë°”ë‹¤ ì•Œ** (500)</span><button class="btn-flat btn-sea buyEggBtn" data-type="seaEgg">êµ¬ë§¤</button></div>`;
    } else if(currentRealm === "hell") {
        shopSeedList.innerHTML += `<div class="shop-item" style="background:#fbe9e7;"><span>ğŸ”¥ **ì§€ì˜¥ ì•Œ** (800)</span><button class="btn-flat btn-hell buyEggBtn" data-type="hellEgg">êµ¬ë§¤</button></div>`;
        shopSeedList.innerHTML += `<div class="shop-item" style="background:#ffebee;"><span>âœ¨ **ì „ì„¤ ì•Œ** (1500)</span><button class="btn-flat btn-legend buyEggBtn" data-type="legendEgg">êµ¬ë§¤</button></div>`;
    } else if(currentRealm === "radioactive") {
        shopSeedList.innerHTML += `<div class="shop-item" style="background:#1b5e20;"><span>â˜¢ï¸ **ë°©ì‚¬ëŠ¥ ì•Œ** (3000)</span><button class="btn-flat btn-radio buyEggBtn" data-type="radioEgg">êµ¬ë§¤</button></div>`;
    }

    const shopItemList = document.getElementById("shopItemList");
    shopItemList.innerHTML = "";
    for(let key in itemInfo){
        const item = itemInfo[key];
        if(key === 'adminwater' && !isAdminMode) continue;
        if(key === 'radioactivewater' && currentRealm !== 'radioactive') continue;

        shopItemList.innerHTML += `<div class="shop-item"><span>${item.name} (${item.cost}ì½”ì¸)</span><button class="btn-flat btn-buy buyItemBtn" data-item="${key}">êµ¬ë§¤</button></div>`;
    }
  }

  function renderAnimalFarm() {
    const container = document.getElementById("animalFarm");
    let realmName = 'ë™ë¬¼ ë†ì¥';
    if(currentRealm === 'hell') realmName = 'ì§€ì˜¥ ë‘¥ì§€';
    if(currentRealm === 'water') realmName = 'ì•„ì¿ ì•„ë¦¬ì›€';
    if(currentRealm === 'radioactive') realmName = 'ëŒì—°ë³€ì´ ë³´í˜¸êµ¬ì—­';

    container.innerHTML = `<h2 class="area-title">ğŸ¾ ${realmName}</h2>`;
    
    if(currentRealm === "normal") {
        container.innerHTML += `
        <div class="pet-section"><div class="pet-stats">
            <div class="pet-card">ğŸ¶ì„±ì¥+5%<div class="pet-count">${pets.dog}</div></div>
            <div class="pet-card">ğŸ±+1000ì›<div class="pet-count">${pets.cat}</div></div>
            <div class="pet-card">ğŸ¸ê¸‰ì„±ì¥<div class="pet-count">${pets.frog}</div></div>
        </div><button class="egg-btn btn-normal buyEggBtn" data-type="egg">ğŸ¥š ìœ¡ì§€ ì•Œ (100)</button></div>`;
    } else if(currentRealm === "water") {
        container.innerHTML += `
        <div class="pet-section" style="background:#002147; border:1px solid #0288d1;">
          <div class="pet-stats">
            <div class="pet-card">ğŸ¦­íŒë§¤+5%<div class="pet-count">${pets.seal}</div></div>
            <div class="pet-card">ğŸ¦€í…œë°œê²¬<div class="pet-count">${pets.crab}</div></div>
            <div class="pet-card">ğŸ¦ˆ2ë°°<div class="pet-count">${pets.shark}</div></div>
          </div><button class="egg-btn btn-sea buyEggBtn" data-type="seaEgg">ğŸ”µ ë°”ë‹¤ ì•Œ (500)</button></div>`;
    } else if(currentRealm === "hell") {
        container.innerHTML += `
        <div class="pet-section" style="background:#260e04; border:1px solid #ff5722;">
          <div class="pet-stats">
            <div class="pet-card">ğŸ˜ˆíŒë§¤+10%<div class="pet-count">${pets.imp}</div></div>
            <div class="pet-card">ğŸ•â€ğŸ¦ºì„±ì¥1.5ë°°<div class="pet-count">${pets.cerberus}</div></div>
            <div class="pet-card">ğŸ‘º2ë°°<div class="pet-count">${pets.devil}</div></div>
          </div><button class="egg-btn btn-hell buyEggBtn" data-type="hellEgg">ğŸ”¥ ì§€ì˜¥ ì•Œ (800)</button>
        </div>
        <div class="pet-section" style="background:#37474f; border:1px solid #d32f2f;">
          <div class="pet-stats">
            <div class="pet-card" style="background:#546e7a; color:white;">ğŸ¦…ì„±ì¥2ë°°<div class="pet-count">${pets.phoenix}</div></div>
            <div class="pet-card" style="background:#546e7a; color:white;">ğŸíŒë§¤3ë°°<div class="pet-count">${pets.hydra}</div></div>
          </div><button class="egg-btn btn-legend buyEggBtn" data-type="legendEgg">âœ¨ ì „ì„¤ ì•Œ (1500)</button>
        </div>`;
    } else if(currentRealm === "radioactive") {
        container.innerHTML += `
        <div class="pet-section" style="background:#000; border:1px solid #76ff03;">
          <div class="pet-stats">
            <div class="pet-card">ğŸ¦ ì½”ì¸ìƒì„±<div class="pet-count">${pets.slime}</div></div>
            <div class="pet-card">ğŸŸì„±ì¥20%<div class="pet-count">${pets.mutantfish}</div></div>
            <div class="pet-card">ğŸ•·ï¸íŒë§¤50%<div class="pet-count">${pets.spider}</div></div>
          </div><button class="egg-btn btn-radio buyEggBtn" data-type="radioEgg">â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì•Œ (3000)</button></div>`;
    }

    if(isAdminMode) {
        container.innerHTML += `<div class="pet-section" style="background:#263238; border:2px solid #fff; margin-top:15px;"><div class="pet-stats"><div class="pet-card" style="background:#333; color:white;">ğŸ²GOD<div class="pet-count">${pets.dragon}</div></div></div><button class="egg-btn btn-admin buyEggBtn" data-type="adminEgg">ğŸ² ë“œë˜ê³¤ ì•Œ (0)</button></div>`;
    }
    container.querySelectorAll(".buyEggBtn").forEach(btn => btn.onclick = () => buyEgg(btn.dataset.type));
  }
  
  function updateInventoryUI() {
    const list = document.getElementById("inventoryListContainer");
    list.innerHTML = "";
    // ì•Œ
    list.innerHTML += `<div class="inv-item"><div>ğŸ¥š ìœ¡ì§€ ì•Œ: ${inventory.egg}</div><div class="hatch-btn-group"><button class="btn-egg-land hatchBtn" data-type="egg" data-count="1">1</button><button class="btn-egg-land hatchBtn" data-type="egg" data-count="10">10</button></div></div>`;
    list.innerHTML += `<div class="inv-item" style="background:#e1f5fe;"><div>ğŸ”µ ë°”ë‹¤ ì•Œ: ${inventory.seaEgg}</div><div class="hatch-btn-group"><button class="btn-egg-sea hatchBtn" data-type="seaEgg" data-count="1">1</button><button class="btn-egg-sea hatchBtn" data-type="seaEgg" data-count="10">10</button></div></div>`;
    list.innerHTML += `<div class="inv-item" style="background:#fbe9e7;"><div>ğŸ”¥ ì§€ì˜¥ ì•Œ: ${inventory.hellEgg}</div><div class="hatch-btn-group"><button class="btn-egg-hell hatchBtn" data-type="hellEgg" data-count="1">1</button><button class="btn-egg-hell hatchBtn" data-type="hellEgg" data-count="10">10</button></div></div>`;
    list.innerHTML += `<div class="inv-item" style="background:#ffebee;"><div>âœ¨ ì „ì„¤ ì•Œ: ${inventory.legendEgg}</div><div class="hatch-btn-group"><button class="btn-egg-legend hatchBtn" data-type="legendEgg" data-count="1">1</button><button class="btn-egg-legend hatchBtn" data-type="legendEgg" data-count="10">10</button></div></div>`;
    list.innerHTML += `<div class="inv-item" style="background:#1b5e20; color:#76ff03;"><div>â˜¢ï¸ ë°©ì‚¬ëŠ¥ ì•Œ: ${inventory.radioEgg}</div><div class="hatch-btn-group"><button class="btn-egg-radio hatchBtn" data-type="radioEgg" data-count="1">1</button><button class="btn-egg-radio hatchBtn" data-type="radioEgg" data-count="10">10</button></div></div>`;

    if(inventory.adminEgg > 0) list.innerHTML += `<div class="inv-item" style="background:#333; color:white;"><div>ğŸ² ë“œë˜ê³¤ ì•Œ: ${inventory.adminEgg}</div><div class="hatch-btn-group"><button class="btn-egg-admin hatchBtn" data-type="adminEgg" data-count="1">1</button><button class="btn-egg-admin hatchBtn" data-type="adminEgg" data-count="10">10</button></div></div>`;
    if(inventory.pearl > 0) list.innerHTML += `<div class="inv-item" style="background:#fce4ec;"><div>ğŸ”® ì§„ì£¼: ${inventory.pearl}</div><button class="btn-flat" style="background:#e91e63; color:white;" onclick="sellPearl()">íŒë§¤(10ë§Œ)</button></div>`;
    
    // ì•„ì´í…œ
    list.innerHTML += `<hr><div class="inv-item">ğŸ’§ ë¬¼: ${inventory.water}</div><div class="inv-item">âœ¨ í™©ê¸ˆë¬¼: ${inventory.goldwater}</div><div class="inv-item">ğŸ’ ë‹¤ì´ì•„ë¬¼: ${inventory.diamondwater}</div><div class="inv-item">ğŸ’š ì—ë©”ë„ë“œë¬¼: ${inventory.emeraldwater}</div>`;
    if(inventory.radioactivewater > 0) list.innerHTML += `<div class="inv-item" style="color:#76ff03; background:#000; font-weight:bold;">â˜¢ï¸ ë°©ì‚¬ëŠ¥ë¬¼: ${inventory.radioactivewater}</div>`;
    if(inventory.adminwater > 0) list.innerHTML += `<div class="inv-item" style="color:#ff9800; font-weight:bold;">âš¡ ê´€ë¦¬ìë¬¼: ${inventory.adminwater}</div>`;
    
    // ì”¨ì•—
    let seedHtml = "<hr>";
    for(let key in allPlants) {
        if(inventory[key] > 0 || (allPlants[key].realm === currentRealm && (key !== 'dragonfruit' || isAdminMode))) {
            seedHtml += `<div class="inv-item">${allPlants[key].name}: ${inventory[key]}</div>`;
        }
    }
    list.innerHTML += seedHtml;

    list.querySelectorAll(".hatchBtn").forEach(btn => btn.onclick = () => hatchEggs(btn.dataset.type, Number(btn.dataset.count)));
  }

  window.sellPearl = function() {
      if(inventory.pearl > 0) { inventory.pearl--; coins += 100000; updateCoinDisplay(); updateInventoryUI(); showMsg("ğŸ”® ì§„ì£¼ íŒë§¤!"); }
  };

  function updateSelectionUI(){
    document.querySelectorAll(".seed").forEach(el => el.classList.toggle("selected", el.dataset.type === selectedSeed));
    document.querySelectorAll(".item").forEach(el => el.classList.toggle("selected", el.dataset.item === selectedItem));
  }

  // ========================
  // 5. ë¬´í•œ í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ
  // ========================
  function generateNewQuest() {
      // í˜„ì¬ ë ë¦„ì—ì„œ ê°€ëŠ¥í•œ ì‘ë¬¼ ëª©ë¡
      const possiblePlants = Object.keys(allPlants).filter(k => allPlants[k].realm === currentRealm && k !== 'dragonfruit');
      
      if(possiblePlants.length === 0) return;

      const randomPlant = possiblePlants[Math.floor(Math.random() * possiblePlants.length)];
      const randomCount = Math.floor(Math.random() * 5) + 3; // 3~7ê°œ ëœë¤
      
      const plantData = allPlants[randomPlant];
      const reward = Math.floor(plantData.sell * randomCount * 1.5); // ë³´ìƒì€ íŒë§¤ê°€ì˜ 1.5ë°°

      currentQuest = {
          target: randomPlant,
          targetName: plantData.name,
          count: randomCount,
          current: 0,
          reward: reward
      };
      saveGame();
      renderQuestList();
  }

  function checkQuest(harvestedType) {
      if(!currentQuest) {
          generateNewQuest();
          return;
      }
      
      // ë ë¦„ì´ ë°”ë€Œì–´ì„œ í€˜ìŠ¤íŠ¸ ìˆ˜í–‰ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ë°©ì§€
      if(allPlants[currentQuest.target].realm !== currentRealm) {
          generateNewQuest();
          return;
      }

      if(harvestedType === currentQuest.target) {
          currentQuest.current++;
          if(currentQuest.current >= currentQuest.count) {
              coins += currentQuest.reward;
              showMsg(`ğŸ“œ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! +${currentQuest.reward}ì½”ì¸`);
              updateCoinDisplay();
              generateNewQuest(); // ì¦‰ì‹œ ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ ìƒì„±
          } else {
              renderQuestList(); // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
          }
      }
  }

  function renderQuestList() {
      const container = document.getElementById("questList");
      container.innerHTML = "";
      
      if(!currentQuest) {
          generateNewQuest(); // í€˜ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
          return;
      }

      let borderColor = '#4caf50';
      if(currentRealm === 'hell') borderColor = '#ff5722';
      else if(currentRealm === 'water') borderColor = '#0288d1';
      else if(currentRealm === 'radioactive') borderColor = '#76ff03';

      container.innerHTML = `
      <div class="quest-item" style="border:2px solid ${borderColor};">
         <div>
            <div class="quest-desc">${currentQuest.targetName} ${currentQuest.count}ê°œ ìˆ˜í™•</div>
            <div class="quest-progress">ë³´ìƒ: ${currentQuest.reward}ì½”ì¸</div>
         </div>
         <div style="color:blue; font-weight:bold;">
            (${currentQuest.current}/${currentQuest.count})
         </div>
      </div>
      <div style="font-size:12px; color:#666; margin-top:5px; text-align:center;">
        ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ ìƒˆ í€˜ìŠ¤íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.
      </div>
      <button class="btn-flat" style="margin-top:5px; width:100%; font-size:11px;" onclick="location.reload()">í€˜ìŠ¤íŠ¸ê°€ ì´ìƒí•˜ë©´ ìƒˆë¡œê³ ì¹¨</button>
      `;
  }

  document.getElementById("questBtn").onclick = () => {
      renderQuestList();
      document.getElementById("questWindow").classList.remove("hidden");
  }

  // ========================
  // 6. êµ¬ë§¤ / íƒ€ì¼ / ìˆ˜í™•
  // ========================
  document.querySelectorAll(".item").forEach(btn => btn.onclick = () => {
      const i = btn.dataset.item;
      if(selectedItem === i) selectedItem = null; else { selectedItem = i; selectedSeed = null; }
      updateSelectionUI();
  });

  document.getElementById("shopWindow").addEventListener("click", (e) => {
    if(e.target.classList.contains("buyItemBtn")){
      const k = e.target.dataset.item;
      if(coins >= itemInfo[k].cost){ coins -= itemInfo[k].cost; inventory[k]++; updateCoinDisplay(); updateInventoryUI(); showMsg("êµ¬ë§¤ ì„±ê³µ"); } 
      else showMsg("ì½”ì¸ ë¶€ì¡±");
    }
    if(e.target.classList.contains("buySeedBtn")){
      const k = e.target.dataset.seed;
      if(coins >= allPlants[k].cost){ coins -= allPlants[k].cost; inventory[k]++; updateCoinDisplay(); updateInventoryUI(); showMsg("êµ¬ë§¤ ì„±ê³µ"); }
      else showMsg("ì½”ì¸ ë¶€ì¡±");
    }
    if(e.target.classList.contains("buyEggBtn")) buyEgg(e.target.dataset.type);
  });

  function buyEgg(type) {
    let c = (type==='egg'?100:(type==='seaEgg'?500:(type==='hellEgg'?800:(type==='legendEgg'?1500:(type==='radioEgg'?3000:0)))));
    if(coins < c) { showMsg("ì½”ì¸ ë¶€ì¡±"); return; }
    coins -= c; inventory[type]++; updateCoinDisplay(); updateInventoryUI(); showMsg("ì•Œ êµ¬ë§¤!");
  }

  function hatchEggs(type, count) {
    if(inventory[type] < count) { showMsg("ì•Œ ë¶€ì¡±"); return; }
    inventory[type] -= count;
    let res = {};
    for(let i=0; i<count; i++) {
        const r = Math.random();
        let k = "";
        if(type==='egg') k = (r<0.8?'dog':(r<0.95?'cat':'frog'));
        else if(type==='seaEgg') k = (r<0.5?'seal':(r<0.8?'crab':'shark'));
        else if(type==='hellEgg') k = (r<0.5?'imp':(r<0.8?'cerberus':'devil'));
        else if(type==='legendEgg') k = (r<0.5?'phoenix':'hydra');
        else if(type==='radioEgg') k = (r<0.5?'slime':(r<0.8?'mutantfish':'spider'));
        else k = 'dragon';
        pets[k]++; res[k] = (res[k]||0)+1;
    }
    updateInventoryUI(); if(document.getElementById("animalFarm")) renderAnimalFarm();
    
    // ê²°ê³¼ì°½
    const win = document.getElementById("hatchWindow");
    win.classList.remove("hidden");
    document.getElementById("hatchIcon").classList.add("egg-hatch-animation");
    document.getElementById("hatchName").textContent = "ë¶€í™”ì¤‘...";
    setTimeout(() => {
        let txt = ""; 
        for(let k in res) txt += `${petInfo[k].icon}x${res[k]} `;
        document.getElementById("hatchName").textContent = "ê²°ê³¼!";
        document.getElementById("hatchSummary").textContent = txt;
        document.getElementById("hatchIcon").classList.remove("egg-hatch-animation");
    }, 500);
  }

  // ì „ì²´ ìˆ˜í™• ê¸°ëŠ¥ - (ì‹¬ê¸° ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì„ íƒ ì ì‹œ í•´ì œ)
  document.getElementById("harvestAllBtn").onclick = () => {
      // ì‹¤ìˆ˜ë¡œ ì‹¬ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì„ íƒëœ ë„êµ¬ ì ì‹œ í•´ì œ
      const tempSeed = selectedSeed;
      const tempItem = selectedItem;
      selectedSeed = null; 
      selectedItem = null;
      updateSelectionUI();

      let harvestedCount = 0;
      document.querySelectorAll(".tile").forEach(tile => {
          if(tile.dataset.plant && Number(tile.dataset.time) <= Date.now()) {
              if(tile.dataset.plant !== 'moneytree') {
                  onTileClick(tile); 
                  harvestedCount++;
              }
          }
      });
      
      // ì›ë˜ ì„ íƒ ìƒíƒœ ë³µêµ¬ (ì„ íƒì , ì—¬ê¸°ì„œëŠ” UXë¥¼ ìœ„í•´ ë³µêµ¬ ì•ˆí•¨)
      if(harvestedCount > 0) showMsg(`ğŸšœ ${harvestedCount}ê°œ ìˆ˜í™• ì™„ë£Œ!`);
      else showMsg("ìˆ˜í™•í•  ì‘ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
  };

  function onTileClick(tile){
    const plantType = tile.dataset.plant;

    // ì•„ì´í…œ ì‚¬ìš©
    if(selectedItem && plantType){
      if(inventory[selectedItem] <= 0){ showMsg("ì•„ì´í…œ ë¶€ì¡±"); return; }
      inventory[selectedItem]--; updateInventoryUI();
      let endTime = Number(tile.dataset.time);
      endTime -= itemInfo[selectedItem].reduce;
      if(endTime < Date.now()) endTime = Date.now();
      tile.dataset.time = endTime;
      showFloatText(tile, "ì‹œê°„ ë‹¨ì¶•! â³");
      return;
    }

    // ìˆ˜í™•
    if(plantType){
      if(Date.now() >= Number(tile.dataset.time)){
        
        // ëˆë‚˜ë¬´ ë¡œì§
        if(plantType === 'moneytree'){
            let touches = Number(tile.dataset.touches || 0);
            const gain = Math.floor(Math.random() * 9001) + 1000;
            coins += gain; updateCoinDisplay();
            showFloatText(tile, `+${gain}`);
            checkQuest('moneytree'); 
            touches++; tile.dataset.touches = touches;
            if(touches >= 3) clearTile(tile);
            else { tile.style.transform = "scale(0.9)"; setTimeout(()=>tile.style.transform="scale(1)", 100); }
            return;
        }

        // íŒë§¤ê°€ ê³„ì‚°
        let sellPrice = allPlants[plantType].sell;
        
        // í« ë³´ë„ˆìŠ¤ ì ìš©
        if(pets.seal > 0) sellPrice *= (1 + pets.seal * 0.05); // ë¬¼ê°œ
        if(pets.imp > 0) sellPrice *= (1 + pets.imp * 0.1); // ì„í”„
        if(pets.spider > 0) sellPrice *= (1 + pets.spider * 0.5); // ê±°ëŒ€ ê±°ë¯¸ (50% ì¦ê°€)
        if(pets.hydra > 0) sellPrice *= (1 + pets.hydra * 2); 
        if(pets.dragon > 0) sellPrice *= (1 + pets.dragon * 4); 

        let isCrit = false;
        // í¬ë¦¬í‹°ì»¬ í™•ë¥  (ìƒì–´+ì•…ë§ˆ)
        let critChance = (pets.shark * 0.2) + (pets.devil * 0.3);
        if(Math.random() < critChance) { sellPrice *= 2; isCrit = true; }

        sellPrice = Math.floor(sellPrice);
        coins += sellPrice; 
        updateCoinDisplay();
        
        // í€˜ìŠ¤íŠ¸ ì²´í¬
        checkQuest(plantType);

        let txt = `+${sellPrice}`;
        if(isCrit) txt = `âœ¨ ${txt}`;
        showFloatText(tile, txt, isCrit ? "#ff1744" : "#ffeb3b");
        
        // ê½ƒê²Œ ì•„ì´í…œ ë°œê²¬
        if(pets.crab > 0 && Math.random() < 0.1) { 
            inventory.water++; updateInventoryUI(); showMsg("ğŸ¦€ ê½ƒê²Œê°€ ë¬¼ë¿Œë¦¬ê°œë¥¼ ì°¾ìŒ!"); 
        }
        
        // ì¡°ê°œ/í™©ê¸ˆì¡°ê°œ ì§„ì£¼ ë°œê²¬
        if((plantType === 'clam' || plantType === 'goldenclam') && Math.random() < (plantType==='goldenclam'?0.05:0.01)) {
             inventory.pearl++; updateInventoryUI(); showMsg("âœ¨ ì§„ì£¼ ë°œê²¬!");
             showFloatText(tile, "ğŸ”® ì§„ì£¼!", "#e91e63");
        }
        
        // ë¶ˆê°€ì‚¬ë¦¬ ë³„ê°€ë£¨
        if(plantType === 'starfish' && Math.random() < 0.2) {
            coins += 5000; updateCoinDisplay(); showMsg("â­ ë³„ê°€ë£¨ íšë“! (+5000)");
            showFloatText(tile, "+5000", "#ffab00");
        }

        clearTile(tile);
      } else {
        showMsg("ìë¼ëŠ” ì¤‘...");
      }
      return;
    }

    // ì‹¬ê¸°
    if(selectedSeed){
      if(!allPlants[selectedSeed]) { return; } // ì—†ëŠ” ì‘ë¬¼ ì‹¬ê¸° ë°©ì§€

      if(inventory[selectedSeed] > 0){
        inventory[selectedSeed]--; updateInventoryUI();
        
        // ì„±ì¥ ì†ë„ ê³„ì‚° (Safety Check í¬í•¨)
        let speedMult = 1 + (pets.dog * 0.05) + (pets.cerberus * 0.5) + (pets.mutantfish * 0.2) + (pets.phoenix * 1.0) + (pets.dragon * 1.0);
        if(isNaN(speedMult) || speedMult < 1) speedMult = 1; // ë¬´í•œ ë²„ê·¸ ë°©ì§€ ì½”ë“œ

        // ë°©ì‚¬ëŠ¥ ë§µ ì¶”ê°€ ë³´ë„ˆìŠ¤ (ê´€ë¦¬ìëª¨ë“œ ì•„ë‹ˆë©´ ì ìš©)
        if(currentRealm === 'radioactive' && !isAdminMode) speedMult *= 3;
        
        // growSpeedê°€ 0ì´ë©´ ë¬´í•œëŒ€ ì‹œê°„ì´ ë˜ë¯€ë¡œ ë°©ì–´ ì½”ë“œ
        let safeGrowSpeed = (growSpeed > 0) ? growSpeed : 1;

        const baseTime = allPlants[selectedSeed].grow / safeGrowSpeed;
        
        // ì‹œê°„ ê³„ì‚° (ë¬´í•œ ë²„ê·¸ ì›ì²œ ì°¨ë‹¨)
        const finalDuration = baseTime / speedMult;
        if(!isFinite(finalDuration)) {
            tile.dataset.time = Date.now() + 1000; // ì˜¤ë¥˜ ì‹œ 1ì´ˆ ë’¤ ì™„ë£Œ
        } else {
            tile.dataset.time = Date.now() + finalDuration;
        }

        tile.dataset.plant = selectedSeed;
        if(selectedSeed === 'moneytree') tile.dataset.touches = 0;

        const initialIcon = (selectedSeed==='dragonfruit'?'ğŸ”¥':(selectedSeed==='helltree'?'ğŸ”¥':(selectedSeed==='clam'?'ğŸ’§':'ğŸŒ±')));
        tile.innerHTML = `<div class="plant">${initialIcon}</div><div class="timer">...</div>`;
      } else {
        showMsg("ì”¨ì•— ë¶€ì¡±");
      }
    }
  }

  function clearTile(tile){
    tile.innerHTML = "";
    tile.dataset.plant = "";
    tile.removeAttribute("data-time"); tile.removeAttribute("data-touches");
  }

  // íƒ€ì´ë¨¸ ë£¨í”„
  setInterval(() => {
    document.querySelectorAll(".tile").forEach(tile => {
      const type = tile.dataset.plant;
      if(!type) return;
      
      const targetTime = Number(tile.dataset.time);
      
      // NaN ì²´í¬ ë° ìë™ ë³µêµ¬ (ë¬´í•œ ë²„ê·¸ ì‹œê°ì  ìˆ˜ì •)
      if(isNaN(targetTime)) {
          tile.dataset.time = Date.now(); // ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
          return;
      }

      const timeLeft = targetTime - Date.now();
      const plantDiv = tile.querySelector(".plant");
      const timerDiv = tile.querySelector(".timer");

      // ë‹¨ê³„ë³„ ì•„ì´ì½˜ í‘œì‹œ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
      if(plantDiv && allPlants[type]){
        if(timeLeft <= 0) plantDiv.textContent = allPlants[type].stages[2];
        else if(timeLeft < (allPlants[type].grow/growSpeed)/2) plantDiv.textContent = allPlants[type].stages[1];
        else plantDiv.textContent = allPlants[type].stages[0];
      }

      if(timerDiv){
        if(timeLeft <= 0){
           if(type === 'moneytree') timerDiv.textContent = `í„°ì¹˜: ${3 - (Number(tile.dataset.touches)||0)}`;
           else timerDiv.textContent = "ìˆ˜í™•!";
           timerDiv.style.background = (type === 'moneytree' ? "#9c27b0" : "#4caf50");
        } else {
           const s = Math.ceil(timeLeft / 1000);
           timerDiv.textContent = s > 60 ? `${Math.ceil(s/60)}ë¶„` : `${s}ì´ˆ`;
           timerDiv.style.background = "rgba(0,0,0,0.6)";
        }
      }
    });
  }, 200);

  // í« íš¨ê³¼ ë£¨í”„ (ê³ ì–‘ì´, ìŠ¬ë¼ì„)
  setInterval(() => { 
    if(pets.cat > 0) { coins += pets.cat*1000; updateCoinDisplay(); } 
    if(pets.slime > 0) { coins += pets.slime*2000; updateCoinDisplay(); } // ìŠ¬ë¼ì„ ì½”ì¸ ìƒì„±
  }, 10000);
  
  // ê°œêµ¬ë¦¬
  setInterval(() => {
      if(pets.frog > 0) {
          const growing = Array.from(document.querySelectorAll(".tile")).filter(t => t.dataset.plant && Number(t.dataset.time) > Date.now());
          if(growing.length > 0) {
              const t = growing[Math.floor(Math.random()*growing.length)];
              t.dataset.time = Date.now(); showFloatText(t, "ğŸ¸ ì í”„!", "#4caf50");
          }
      }
  }, 60000);

  // ë“œë˜ê³¤
  setInterval(() => {
    if(pets.dragon > 0){
        const growing = Array.from(document.querySelectorAll(".tile")).filter(t => t.dataset.plant && Number(t.dataset.time) > Date.now());
        if(growing.length > 0){
            growing.sort(() => Math.random()-0.5);
            let cnt = 0;
            for(let t of growing){
                if(cnt >= pets.dragon*3) break;
                t.dataset.time = Date.now(); showFloatText(t, "ğŸ”¥ í¬íš¨!", "#d32f2f"); cnt++;
            }
        }
    }
  }, 10000);

  // UI í•¸ë“¤ëŸ¬
  document.getElementById("settingBtn").onclick = () => document.getElementById("settingWindow").classList.remove("hidden");
  
  // ë‹«ê¸° ë²„íŠ¼ë“¤
  document.getElementById("closeSetting").onclick = () => document.getElementById("settingWindow").classList.add("hidden");
  document.getElementById("closeShop").onclick = () => document.getElementById("shopWindow").classList.add("hidden");
  document.getElementById("closeInv").onclick = () => document.getElementById("inventoryWindow").classList.add("hidden");
  document.getElementById("closeQuest").onclick = () => document.getElementById("questWindow").classList.add("hidden");
  document.getElementById("closeHatchBtn").onclick = () => document.getElementById("hatchWindow").classList.add("hidden");

  // ë°ì´í„° ì´ˆê¸°í™” ë²„íŠ¼
  document.getElementById("resetGameBtn").onclick = resetGame;
  
  // ë‚œì´ë„ ë²„íŠ¼
  document.querySelectorAll(".btn-diff-select").forEach(btn => btn.onclick = (e) => {
      currentDiff = btn.dataset.diff;
      if(currentDiff === "easy") coins = 500;
      else if(currentDiff === "normal") coins = 300;
      else if(currentDiff === "hard") coins = 150;
      
      updateCoinDisplay();
      document.getElementById("settingWindow").classList.add("hidden");
      refreshUI();
      showMsg("ë‚œì´ë„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
  });

  document.getElementById("shopBtn").onclick = () => document.getElementById("shopWindow").classList.remove("hidden");
  document.getElementById("inventoryBtn").onclick = () => { updateInventoryUI(); document.getElementById("inventoryWindow").classList.remove("hidden"); };

  function showMsg(txt){
    const msg = document.getElementById("msg"); msg.textContent = txt;
    msg.style.opacity = 1; setTimeout(()=>msg.style.opacity=0, 2000);
  }
  function updateCoinDisplay(){ document.getElementById("coins").textContent = `ğŸ’° ${coins.toLocaleString()}`; }
  function showFloatText(el, txt, col){
    const f = document.createElement("div"); f.className="float-text"; f.textContent=txt;
    if(col) f.style.color=col; el.appendChild(f); setTimeout(()=>f.remove(), 800);
  }
});
</script>
</body>
</html>
